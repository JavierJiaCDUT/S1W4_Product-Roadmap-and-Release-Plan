<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>第四周课程：敏捷项目路线图与发布计划</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- Application Structure Plan: The application is structured into five thematic, navigable sections corresponding to the lecture's main topics: Core Philosophy, Product Roadmap, Release Plan, Agile Estimation, and PMBOK Connection. This tab-based structure allows users non-linear access to content, empowering them to explore topics based on interest rather than following a rigid, linear path. This design choice transforms the static lecture plan into an interactive learning module, enhancing usability and engagement by breaking down the content into digestible, self-contained chunks. -->
    <!-- Visualization & Content Choices: 
        1.  Report Info: Agile vs. Traditional Planning -> Goal: Compare -> Viz: Side-by-side HTML/CSS table -> Interaction: Static -> Justification: Provides a clear, direct comparison of core tenets. -> Library/Method: HTML/Tailwind.
        2.  Report Info: Roadmap & Release Plan Hierarchy -> Goal: Organize/Show Relationship -> Viz: Interactive hierarchical diagram -> Interaction: Clicking a level (Vision, Roadmap, Release) highlights it and displays its details in an adjacent panel. -> Justification: Makes the abstract strategic-to-tactical flow tangible and explorable. -> Library/Method: HTML/Tailwind, JS for interaction.
        3.  Report Info: Story Points & Velocity -> Goal: Demonstrate Change & Process -> Viz: Interactive bar chart for Velocity & a Planning Poker simulation -> Interaction: A button updates the velocity chart to simulate sprint completion. Users click cards to participate in a mock estimation vote. -> Justification: Active participation solidifies understanding of these dynamic concepts far better than static text. -> Library/Method: Chart.js, HTML/Tailwind, JS.
        4.  Report Info: User Story Generation from Vision -> Goal: Apply knowledge -> Viz: Text area for input, button for action, and a text block for output -> Interaction: User enters a vision and clicks a button to generate user stories and story point estimates using the Gemini API. -> Justification: Provides a practical, hands-on tool to connect product vision with tangible, actionable user stories, directly reinforcing a key learning objective of the lecture plan. -> Library/Method: HTML/Tailwind, JS, Gemini API.
        5.  Report Info: Release Plan Generation from Goal -> Goal: Apply knowledge -> Viz: Text area for input, button for action, and a text block for output -> Interaction: User enters a release goal and clicks a button to generate a draft release plan using the Gemini API. -> Justification: Creates a tangible link between a high-level goal and tactical planning, reinforcing the lecture's content on release planning. -> Library/Method: HTML/Tailwind, JS, Gemini API.
        6.  Report Info: PMBOK & Agile Relationship Explanation -> Goal: Explain/Synthesize -> Viz: Button and a collapsible text block -> Interaction: User clicks a button to reveal a detailed, AI-generated explanation of the relationship between Agile and PMBOK planning concepts. -> Justification: Offers a dynamic way to dive deeper into a key theoretical connection, providing richer context than static text alone. -> Library/Method: HTML/Tailwind, JS, Gemini API.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #fdfcf9;
            color: #334155;
        }
        .nav-button {
            transition: all 0.3s ease;
            border-bottom: 4px solid transparent;
        }
        .nav-button.active {
            color: #0d9488;
            border-bottom-color: #0d9488;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .diagram-item {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .diagram-item.selected {
            background-color: #ccfbf1;
            transform: scale(1.05);
            box-shadow: 0 4px 14px 0 rgba(13, 148, 136, 0.2);
        }
        .poker-card {
            transition: all 0.2s ease-in-out;
        }
        .poker-card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 320px;
            max-height: 400px;
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto px-4 py-8 md:py-12">
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-teal-700">Product Planning: Agile Project Roadmap and Release Plan</h1>
            <p class="mt-2 text-lg text-slate-500">第四周课程交互式学习指南</p>
        </header>

        <nav class="flex flex-wrap justify-center border-b-2 border-slate-200 mb-8">
            <button data-target="intro" class="nav-button active text-sm md:text-base font-medium px-4 py-3 md:px-6 md:py-4">1. Core Concepts</button>
            <button data-target="roadmap" class="nav-button text-sm md:text-base font-medium px-4 py-3 md:px-6 md:py-4">2. Product Roadmap</button>
            <button data-target="release" class="nav-button text-sm md:text-base font-medium px-4 py-3 md:px-6 md:py-4">3. Release Plan</button>
            <button data-target="estimation" class="nav-button text-sm md:text-base font-medium px-4 py-3 md:px-6 md:py-4">4. Agile Estimation</button>
            <button data-target="pmbok" class="nav-button text-sm md:text-base font-medium px-4 py-3 md:px-6 md:py-4">5.PMBOK</button>
        </nav>

        <main>
            <section id="intro" class="content-section active">
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-sm">
                    <h2 class="text-2xl font-bold text-teal-600 mb-4">The bridge from 'vision' to 'action'</h2>
                    <p class="mb-6 text-slate-600">In the past few weeks, we started with innovative ideas and used user stories and user story maps to refine and structure vague requirements and establish a product vision. Now we have a vision and a list of prioritised requirements, but how do we turn them into an executable, rhythmic development plan? This is where agile project planning comes in. Its goal is to provide direction in the face of uncertainty and allow for adjustments as we learn.</p>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="border-2 border-rose-200 rounded-lg p-4 bg-rose-50/50">
                            <h3 class="text-xl font-semibold text-rose-800 mb-3">⚙️ Traditional Planning</h3>
                            <ul class="list-disc list-inside space-y-2 text-slate-700">
                                <li>Emphasizes <strong>detail</strong> and <strong>fixed</strong></li>
                                <li>Complete plans are established at the project's outset</li>
                                <li>Changes are seen as risks and need strict control</li>
                                <li>Goal is to <strong>follow the plan</strong></li>
                            </ul>
                        </div>
                        <div class="border-2 border-sky-200 rounded-lg p-4 bg-sky-50/50">
                            <h3 class="text-xl font-semibold text-sky-800 mb-3">🔄 Agile Planning</h3>
                            <ul class="list-disc list-inside space-y-2 text-slate-700">
                                <li>Emphasizes <strong>flexibility</strong> and <strong>response to change</strong></li>
                                <li>Planning is a continuous, iterative activity</li>
                                <li>Embrace change, treat it as a learning opportunity</li>
                                <li>Goal is to <strong>deliver value</strong></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <section id="roadmap" class="content-section">
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-sm">
                    <h2 class="text-2xl font-bold text-teal-600 mb-2">Product Roadmap</h2>
                    <p class="mb-6 text-slate-600">The product roadmap is a high-level view of the product's evolution over time, which communicates the product's future direction, key milestones, and delivered value. It is not a detailed plan in the form of a Gantt chart, but a strategic document that answers "Where do we want to go in the future?" Please click on the different levels of the diagram below to view their constituent elements.</p>
                    <div class="flex flex-col md:flex-row justify-center items-center">
                        <div class="lg:w-1/2">
                            <div class="space-y-4 text-center">
                                <div id="diagram-vision" class="diagram-item p-4 border-2 border-amber-300 rounded-lg bg-amber-50">
                                    <h3 class="text-xl font-bold text-amber-800">Vision</h3>
                                    <p class="text-sm text-amber-700">Core driver</p>
                                </div>
                                <div class="text-2xl text-slate-400">▼</div>
                                <div id="diagram-roadmap" class="diagram-item p-4 border-2 border-sky-300 rounded-lg bg-sky-50">
                                    <h3 class="text-xl font-bold text-sky-800">Roadmap</h3>
                                    <p class="text-sm text-sky-700">Strategic direction</p>
                                </div>
                                <div class="text-2xl text-slate-400">▼</div>
                                <div id="diagram-release" class="diagram-item p-4 border-2 border-emerald-300 rounded-lg bg-emerald-50">
                                    <h3 class="text-xl font-bold text-emerald-800">Release Plan</h3>
                                     <p class="text-sm text-emerald-700">Tactical execution</p>
                                </div>
                            </div>
                        </div>
                        <div class="lg:w-1/2 mt-8 lg:mt-0">
                            <div id="diagram-details" class="p-6 bg-slate-50 rounded-lg h-full">
                                <h3 id="details-title" class="text-xl font-bold text-slate-700 mb-4">Please select a level</h3>
                                <div id="details-content" class="text-slate-600 space-y-2">
                                    <p>Click on "Vision," "Product Roadmap," or "Release Plan" on the left to view the details.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="release" class="content-section">
                 <div class="bg-white p-6 md:p-8 rounded-xl shadow-sm">
                    <h2 class="text-2xl font-bold text-teal-600 mb-2">Release Plan</h2>
                    <p class="mb-6 text-slate-600">The release plan is the next layer of the product roadmap, which more specifically details which features will be delivered in a specific release version and when. It transforms the high-level roadmap themes into executable feature sets, serving as the critical bridge connecting strategy and tactics.</p>
                    <div class="bg-slate-50 rounded-lg p-6">
                        <h3 class="text-xl font-bold text-slate-700 mb-4">Typical Elements of a Release Plan</h3>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-semibold text-slate-800">🎯 Release Goal</h4>
                                <p class="text-sm text-slate-600">The core purpose of this release, such as "launching an MVP version to validate core value."</p>
                            </div>
                            <div>
                                <h4 class="font-semibold text-slate-800">📦 Release Scope (Release Scope)</h4>
                                <p class="text-sm text-slate-600">The set of key features to be delivered in this release, typically from the product backlog's high-priority items.</p>
                            </div>
                            <div>
                                <h4 class="font-semibold text-slate-800">🗓️ Release Date</h4>
                                <p class="text-sm text-slate-600">The expected delivery time window, such as "end of Q3."</p>
                            </div>
                            <div>
                                <h4 class="font-semibold text-slate-800">🔗 Dependencies & Risks</h4>
                                <p class="text-sm text-slate-600">The potential internal and external dependencies that may impact the release, along with the associated risks and mitigation strategies.</p>
                            </div>
                        </div>
                        <div class="mt-6 pt-4 border-t border-slate-200">
                            <h4 class="font-semibold text-slate-800">Methodology</h4>
                            <p class="text-sm text-slate-600">Select high-value features from the product backlog, plan them in collaboration with the development team, and commit to their delivery. Agile recommends small, frequent releases to quickly gather market feedback.</p>
                        </div>
                    </div>
                    <div class="bg-teal-50 p-6 md:p-8 rounded-xl shadow-sm mt-8">
                        <h2 class="text-2xl font-bold text-teal-700 mb-4">✨ Release Plan Helper</h2>
                        <p class="mb-4 text-slate-600">Input a release goal, and let AI help you generate a preliminary release plan outline.</p>
                        <textarea id="release-goal-input" class="w-full h-16 p-3 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-teal-500 mb-4" placeholder="例如：发布一款面向移动端用户的MVP，核心功能是快速分享照片。"></textarea>
                        <button id="generate-release-btn" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition-colors flex items-center justify-center">
                            <span id="generate-release-text">生成发布计划 ✨</span>
                            <span id="generate-release-spinner" class="hidden animate-spin h-5 w-5 border-4 border-white border-t-transparent rounded-full ml-2"></span>
                        </button>
                        <div id="generated-release-output" class="bg-white p-4 mt-6 rounded-lg border border-slate-200 space-y-4">
                            <p id="release-output-placeholder" class="text-slate-400 italic text-center">生成的发布计划大纲将在此处显示...</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="estimation" class="content-section">
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-sm">
                    <h2 class="text-2xl font-bold text-teal-600 mb-2">敏捷估算：故事点与团队速度</h2>
                    <p class="mb-6 text-slate-600">敏捷估算不追求精确的小时数，而是通过相对估算来理解工作量。故事点是一个抽象单位，代表工作的复杂度、工作量和不确定性。团队在一个迭代中完成的故事点总和，即为“速度”。</p>
                    <div class="grid lg:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-xl font-semibold text-slate-700 mb-4 text-center">团队速度 (Velocity) 追踪</h3>
                            <p class="text-sm text-slate-500 mb-4 text-center">速度用于预测未来，而非绩效考核。它会自然波动。点击下方按钮模拟完成一次迭代。</p>
                            <div class="chart-container">
                                <canvas id="velocityChart"></canvas>
                            </div>
                            <div class="text-center mt-4">
                                <button id="addSprintButton" class="bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 transition-colors">完成一个新迭代</button>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-slate-700 mb-4 text-center">扑克牌估算 (Planning Poker) 模拟</h3>
                            <p class="text-sm text-slate-500 mb-4 text-center">团队成员对一个用户故事匿名估算，然后讨论差异以达成共识。</p>
                            <div class="bg-slate-50 p-4 rounded-lg text-center">
                                <p class="font-semibold">用户故事：</p>
                                <p id="poker-story" class="text-slate-800 mb-4">“作为一名用户，我希望能用邮箱和密码注册账号。”</p>
                                <p class="font-semibold mb-2">请选择你认为的故事点：</p>
                                <div class="flex justify-center flex-wrap gap-2">
                                    <button class="poker-card w-12 h-16 bg-white rounded-lg shadow font-bold text-xl border-2 border-slate-200" data-value="1">1</button>
                                    <button class="poker-card w-12 h-16 bg-white rounded-lg shadow font-bold text-xl border-2 border-slate-200" data-value="2">2</button>
                                    <button class="poker-card w-12 h-16 bg-white rounded-lg shadow font-bold text-xl border-2 border-slate-200" data-value="3">3</button>
                                    <button class="poker-card w-12 h-16 bg-white rounded-lg shadow font-bold text-xl border-2 border-slate-200" data-value="5">5</button>
                                    <button class="poker-card w-12 h-16 bg-white rounded-lg shadow font-bold text-xl border-2 border-slate-200" data-value="8">8</button>
                                </div>
                                <div id="poker-result" class="mt-4 text-slate-600 h-12"></div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-teal-50 p-6 md:p-8 rounded-xl shadow-sm mt-8">
                        <h2 class="text-2xl font-bold text-teal-700 mb-4">✨ 智能用户故事生成器</h2>
                        <p class="mb-4 text-slate-600">输入一个高层次的产品愿景，让AI为你生成可执行的用户故事和故事点估算，帮助你更好地理解如何将想法转化为敏捷待办事项。</p>
                        <textarea id="vision-input" class="w-full h-24 p-3 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-teal-500 mb-4" placeholder="例如：创建一个校园二手物品交易App，让学生可以方便地买卖闲置物品。"></textarea>
                        <button id="generate-stories-btn" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition-colors flex items-center justify-center">
                            <span id="generate-text">生成用户故事 ✨</span>
                            <span id="generate-spinner" class="hidden animate-spin h-5 w-5 border-4 border-white border-t-transparent rounded-full ml-2"></span>
                        </button>
                        <div id="generated-stories-output" class="bg-white p-4 mt-6 rounded-lg border border-slate-200 space-y-4">
                            <p id="output-placeholder" class="text-slate-400 italic text-center">生成的用户故事将在此处显示...</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="pmbok" class="content-section">
                 <div class="bg-white p-6 md:p-8 rounded-xl shadow-sm">
                    <h2 class="text-2xl font-bold text-teal-600 mb-2">关联 PMBOK 知识领域</h2>
                    <p class="mb-6 text-slate-600">敏捷规划并非空中楼阁，它与 PMBOK 指南中的核心绩效域紧密相连，体现了在现代项目管理中规划、交付和估算的演进。</p>
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-slate-50 p-6 rounded-lg hover:shadow-md transition-shadow">
                            <h3 class="font-bold text-lg text-slate-800 mb-2">规划绩效域</h3>
                            <p class="text-slate-600">敏捷路线图和发布计划是“规划”的具体体现。PMBOK 强调规划是一个渐进明细和迭代的过程，这与敏捷规划理念高度一致。</p>
                        </div>
                        <div class="bg-slate-50 p-6 rounded-lg hover:shadow-md transition-shadow">
                            <h3 class="font-bold text-lg text-slate-800 mb-2">开发方法和生命周期绩效域</h3>
                            <p class="text-slate-600">“交付节奏”是该绩效域关注的重点。敏捷路线图和发布计划正是定义了产品的交付节奏和迭代周期。</p>
                        </div>
                        <div class="bg-slate-50 p-6 rounded-lg hover:shadow-md transition-shadow">
                            <h3 class="font-bold text-lg text-slate-800 mb-2">估算方法 (工具与技术)</h3>
                            <p class="text-slate-600">PMBOK 中有多种估算技术，敏捷中的故事点估算属于其中一种相对估算方法，其目的是为了更好地规划和管理预期。</p>
                        </div>
                    </div>
                    <div class="bg-teal-50 p-6 md:p-8 rounded-xl shadow-sm mt-8">
                        <h2 class="text-2xl font-bold text-teal-700 mb-4">✨ 规划关联解释器</h2>
                        <p class="mb-4 text-slate-600">点击下方按钮，获取关于敏捷规划与PMBOK知识领域之间关系的详细解释。</p>
                        <button id="explain-pmbok-btn" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition-colors flex items-center justify-center">
                            <span id="explain-pmbok-text">解释关联 ✨</span>
                            <span id="explain-pmbok-spinner" class="hidden animate-spin h-5 w-5 border-4 border-white border-t-transparent rounded-full ml-2"></span>
                        </button>
                        <div id="pmbok-explanation-output" class="bg-white p-4 mt-6 rounded-lg border border-slate-200 space-y-4">
                            <p id="pmbok-output-placeholder" class="text-slate-400 italic text-center">点击按钮生成解释...</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const navButtons = document.querySelectorAll('.nav-button');
            const contentSections = document.querySelectorAll('.content-section');

            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    contentSections.forEach(section => section.classList.remove('active'));
                    document.getElementById(button.dataset.target).classList.add('active');
                });
            });

            const diagramData = {
                vision: {
                    title: '愿景 (Vision)',
                    content: '<p>路线图的根本驱动力，是产品的最终目标和存在理由。</p><ul class="list-disc list-inside mt-2"><li>回答“我们为什么要做这个产品？”</li><li>是所有决策的最终标尺</li></ul>'
                },
                roadmap: {
                    title: '产品路线图 (Product Roadmap)',
                    content: '<p>沟通产品未来发展方向的战略性文档。</p><ul class="list-disc list-inside mt-2"><li><strong>构成:</strong> 主题/目标, 时间框架, 关键成果</li><li><strong>特点:</strong> 战略性, 高层次, 灵活, 持续更新</li><li><strong>不包含:</strong> 具体的用户故事、任务细节</li></ul>'
                },
                release: {
                    title: '发布计划 (Release Plan)',
                    content: '<p>更具体地说明在特定发布版本中要交付哪些功能。</p><ul class="list-disc list-inside mt-2"><li><strong>构成:</strong> 发布目标, 发布范围, 发布日期, 依赖与风险</li><li><strong>特点:</strong> 战术性, 更具体, 指导短期交付</li></ul>'
                }
            };

            const diagramItems = document.querySelectorAll('.diagram-item');
            const detailsTitle = document.getElementById('details-title');
            const detailsContent = document.getElementById('details-content');

            diagramItems.forEach(item => {
                item.addEventListener('click', () => {
                    diagramItems.forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                    
                    const key = item.id.split('-')[1];
                    detailsTitle.textContent = diagramData[key].title;
                    detailsContent.innerHTML = diagramData[key].content;
                });
            });
            
            document.getElementById('diagram-roadmap').click();

            let velocityChart;
            const initialData = {
                labels: ['迭代 1', '迭代 2', '迭代 3', '迭代 4'],
                points: [18, 22, 20, 25]
            };

            function createOrUpdateChart() {
                const ctx = document.getElementById('velocityChart').getContext('2d');
                if (velocityChart) {
                    velocityChart.destroy();
                }
                velocityChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: initialData.labels,
                        datasets: [{
                            label: '完成的故事点',
                            data: initialData.points,
                            backgroundColor: 'rgba(13, 148, 136, 0.6)',
                            borderColor: 'rgba(13, 148, 136, 1)',
                            borderWidth: 1,
                            borderRadius: 4,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: '故事点' }
                            },
                            x: {
                                title: { display: true, text: '迭代周期' }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return ` 完成: ${context.parsed.y} 故事点`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            createOrUpdateChart();

            document.getElementById('addSprintButton').addEventListener('click', () => {
                const lastSprintNum = parseInt(initialData.labels[initialData.labels.length - 1].split(' ')[1]);
                initialData.labels.push(`迭代 ${lastSprintNum + 1}`);
                const newPoints = Math.floor(Math.random() * 15) + 15;
                initialData.points.push(newPoints);
                if (initialData.labels.length > 6) {
                    initialData.labels.shift();
                    initialData.points.shift();
                }
                createOrUpdateChart();
            });

            const pokerCards = document.querySelectorAll('.poker-card');
            const pokerResult = document.getElementById('poker-result');
            pokerCards.forEach(card => {
                card.addEventListener('click', (e) => {
                    const yourVote = e.target.dataset.value;
                    pokerResult.innerHTML = `你选择了 <strong>${yourVote}</strong> 点。`;
                    
                    setTimeout(() => {
                        const teamVotes = [1,2,3,5,8].sort(() => 0.5 - Math.random()).slice(0, 3);
                        if (!teamVotes.includes(parseInt(yourVote))) {
                           teamVotes[0] = parseInt(yourVote);
                           teamVotes.sort((a,b) => a-b);
                        }
                        pokerResult.innerHTML += `<br>团队其他成员选择了: <strong>${teamVotes.join(', ')}</strong>。`;
                        if (Math.max(...teamVotes) - Math.min(...teamVotes) > 3) {
                             pokerResult.innerHTML += `<br><span class="font-semibold text-rose-600">差异较大，需要讨论！</span>`;
                        } else {
                             pokerResult.innerHTML += `<br><span class="font-semibold text-emerald-600">估算基本一致！</span>`;
                        }
                    }, 1000);
                });
            });

            const generateStoriesBtn = document.getElementById('generate-stories-btn');
            const visionInput = document.getElementById('vision-input');
            const generatedStoriesOutput = document.getElementById('generated-stories-output');
            const generateText = document.getElementById('generate-text');
            const generateSpinner = document.getElementById('generate-spinner');

            const generateReleaseBtn = document.getElementById('generate-release-btn');
            const releaseGoalInput = document.getElementById('release-goal-input');
            const generatedReleaseOutput = document.getElementById('generated-release-output');
            const generateReleaseText = document.getElementById('generate-release-text');
            const generateReleaseSpinner = document.getElementById('generate-release-spinner');

            const explainPmbokBtn = document.getElementById('explain-pmbok-btn');
            const pmbokExplanationOutput = document.getElementById('pmbok-explanation-output');
            const explainPmbokText = document.getElementById('explain-pmbok-text');
            const explainPmbokSpinner = document.getElementById('explain-pmbok-spinner');

            async function callGeminiApi(prompt, isJson = false) {
                let retries = 0;
                const maxRetries = 3;
                while (retries < maxRetries) {
                    try {
                        const chatHistory = [];
                        chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                        const payload = {
                            contents: chatHistory,
                            generationConfig: {
                                responseMimeType: isJson ? "application/json" : "text/plain",
                                responseSchema: isJson ? {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            "userStory": { "type": "STRING" },
                                            "storyPoints": { "type": "NUMBER" }
                                        },
                                        "propertyOrdering": ["userStory", "storyPoints"]
                                    }
                                } : undefined
                            }
                        };
                        const apiKey = "";
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) {
                            throw new Error(`API call failed with status: ${response.status}`);
                        }
                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                            const text = result.candidates[0].content.parts[0].text;
                            return isJson ? JSON.parse(text) : text;
                        } else {
                            throw new Error("Invalid API response structure.");
                        }
                    } catch (error) {
                        console.error(`Attempt ${retries + 1} failed:`, error);
                        retries++;
                        if (retries < maxRetries) {
                            await new Promise(resolve => setTimeout(resolve, Math.pow(2, retries) * 1000));
                        }
                    }
                }
                throw new Error("Failed to generate content after multiple retries.");
            }

            generateStoriesBtn.addEventListener('click', async () => {
                const vision = visionInput.value.trim();
                if (!vision) {
                    generatedStoriesOutput.innerHTML = '<p class="text-rose-600 text-center">请先输入一个产品愿景！</p>';
                    return;
                }

                generateText.classList.add('hidden');
                generateSpinner.classList.remove('hidden');
                generateStoriesBtn.disabled = true;
                generatedStoriesOutput.innerHTML = '<p class="text-slate-400 italic text-center">正在生成中...</p>';

                const prompt = `为一个产品愿景生成5个用户故事，并为每个故事估算一个故事点。故事点估值应使用敏捷斐波那契数列（1, 2, 3, 5, 8, 13, 21）。
产品愿景: "${vision}"
请以JSON数组格式返回，每个对象包含"userStory"和"storyPoints"字段。`;

                try {
                    const stories = await callGeminiApi(prompt, true);
                    const storyListHtml = stories.map(story => `
                        <div class="bg-slate-50 p-4 rounded-lg flex items-center justify-between shadow-sm">
                            <p class="flex-1 text-slate-800">${story.userStory}</p>
                            <span class="ml-4 font-bold text-lg text-teal-700 bg-teal-200 px-3 py-1 rounded-full">${story.storyPoints}</span>
                        </div>
                    `).join('');
                    generatedStoriesOutput.innerHTML = storyListHtml;
                } catch (error) {
                    console.error("生成失败:", error);
                    generatedStoriesOutput.innerHTML = '<p class="text-rose-600 text-center">生成失败，请稍后再试。</p>';
                } finally {
                    generateText.classList.remove('hidden');
                    generateSpinner.classList.add('hidden');
                    generateStoriesBtn.disabled = false;
                }
            });

            generateReleaseBtn.addEventListener('click', async () => {
                const goal = releaseGoalInput.value.trim();
                if (!goal) {
                    generatedReleaseOutput.innerHTML = '<p class="text-rose-600 text-center">请先输入一个发布目标！</p>';
                    return;
                }

                generateReleaseText.classList.add('hidden');
                generateReleaseSpinner.classList.remove('hidden');
                generateReleaseBtn.disabled = true;
                generatedReleaseOutput.innerHTML = '<p class="text-slate-400 italic text-center">正在生成中...</p>';

                const prompt = `为一个发布目标生成一个发布计划大纲。发布计划应包含：
1. 发布目标（Release Goal）
2. 关键功能（Key Features）- 列表形式
3. 估算时间框架（Estimated Timeframe）- 例如：“一个季度”
4. 潜在风险（Potential Risks）- 列表形式
发布目标: "${goal}"
请以Markdown格式返回。`;

                try {
                    const plan = await callGeminiApi(prompt);
                    const planHtml = plan.split('\n').map(line => {
                        if (line.startsWith('#')) return `<h3 class="font-bold text-lg">${line.substring(2)}</h3>`;
                        if (line.startsWith('##')) return `<h4 class="font-bold">${line.substring(3)}</h4>`;
                        if (line.startsWith('*')) return `<p class="ml-4">${line}</p>`;
                        return `<p>${line}</p>`;
                    }).join('');
                    generatedReleaseOutput.innerHTML = `<div class="prose max-w-none text-slate-700">${planHtml}</div>`;
                } catch (error) {
                    console.error("生成失败:", error);
                    generatedReleaseOutput.innerHTML = '<p class="text-rose-600 text-center">生成失败，请稍后再试。</p>';
                } finally {
                    generateReleaseText.classList.remove('hidden');
                    generateReleaseSpinner.classList.add('hidden');
                    generateReleaseBtn.disabled = false;
                }
            });

            explainPmbokBtn.addEventListener('click', async () => {
                explainPmbokText.classList.add('hidden');
                explainPmbokSpinner.classList.remove('hidden');
                explainPmbokBtn.disabled = true;
                pmbokExplanationOutput.innerHTML = '<p class="text-slate-400 italic text-center">正在生成中...</p>';

                const prompt = `详细解释敏捷规划与PMBOK（项目管理知识体系）中的“规划绩效域”、“开发方法和生命周期绩效域”以及“估算方法”之间的关系和异同点，突出敏捷规划是如何在这些领域中进行演进和实践的。请以易于理解的段落形式返回，并使用中文。`;

                try {
                    const explanation = await callGeminiApi(prompt);
                    pmbokExplanationOutput.innerHTML = `<div class="prose max-w-none text-slate-700 space-y-4">${explanation.split('\n').map(p => `<p>${p}</p>`).join('')}</div>`;
                } catch (error) {
                    console.error("生成失败:", error);
                    pmbokExplanationOutput.innerHTML = '<p class="text-rose-600 text-center">生成失败，请稍后再试。</p>';
                } finally {
                    explainPmbokText.classList.remove('hidden');
                    explainPmbokSpinner.classList.add('hidden');
                    explainPmbokBtn.disabled = false;
                }
            });
        });
    </script>
</body>
</html>
